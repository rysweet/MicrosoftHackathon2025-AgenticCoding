{
  "analysis_metadata": {
    "analysis_type": "Final Quality Pass - Pattern Violations and Code Reuse",
    "files_reviewed": 407,
    "issues_found_previously": 458,
    "new_findings": 12,
    "date": "2025-11-08",
    "focus_areas": [
      "Code duplication not yet identified",
      "Anti-patterns (God objects, Feature envy, Primitive obsession)",
      "Missing design patterns",
      "Circular dependencies"
    ]
  },

  "critical_findings": [
    {
      "id": "PATTERN-001",
      "title": "Bundle Generator: Duplicate setup.py Generation (80% similarity)",
      "category": "code_duplication",
      "severity": "high",
      "impact": "maintenance_burden",
      "files_affected": [
        "src/amplihack/bundle_generator/packager.py:249-279",
        "src/amplihack/bundle_generator/filesystem_packager.py:320-358"
      ],
      "duplication_metrics": {
        "lines_duplicated": 35,
        "similarity_percentage": 85,
        "maintenance_multiplier": 2
      },
      "description": "Two nearly identical _generate_setup_py() methods with only minor formatting differences",
      "code_smell": "Shotgun Surgery - changes to setup.py format require updates in 2 places",
      "consolidation_opportunity": {
        "pattern": "Extract to shared utility",
        "suggested_location": "src/amplihack/bundle_generator/python_packaging_utils.py",
        "estimated_lines_saved": 60,
        "implementation": "Create generate_setup_py(bundle: AgentBundle) -> str function"
      },
      "recommendation": "Extract to shared python_packaging_utils.py module",
      "priority": 1
    },

    {
      "id": "PATTERN-002",
      "title": "Bundle Generator: Duplicate pyproject.toml Generation (75% similarity)",
      "category": "code_duplication",
      "severity": "high",
      "impact": "maintenance_burden",
      "files_affected": [
        "src/amplihack/bundle_generator/filesystem_packager.py:255-318"
      ],
      "duplication_metrics": {
        "lines_duplicated": 63,
        "potential_for_reuse": "high",
        "maintenance_multiplier": 2
      },
      "description": "pyproject.toml generation logic exists in filesystem_packager but not in packager.py - asymmetric duplication",
      "consolidation_opportunity": {
        "pattern": "Extract to shared utility",
        "suggested_location": "src/amplihack/bundle_generator/python_packaging_utils.py",
        "estimated_lines_saved": 120,
        "implementation": "Create generate_pyproject_toml(bundle) and generate_setup_py(bundle) functions"
      },
      "recommendation": "Consolidate all Python packaging generation into single utility module",
      "priority": 1
    },

    {
      "id": "PATTERN-003",
      "title": "Bundle Generator: Duplicate __init__.py Generation (70% similarity)",
      "category": "code_duplication",
      "severity": "medium",
      "impact": "maintenance_burden",
      "files_affected": [
        "src/amplihack/bundle_generator/packager.py:202-247",
        "src/amplihack/bundle_generator/filesystem_packager.py:360-411"
      ],
      "duplication_metrics": {
        "lines_duplicated": 45,
        "similarity_percentage": 70,
        "maintenance_multiplier": 2
      },
      "description": "Two _generate_init_py() methods with similar structure but different implementations",
      "consolidation_opportunity": {
        "pattern": "Template Method Pattern",
        "suggested_location": "src/amplihack/bundle_generator/python_packaging_utils.py",
        "estimated_lines_saved": 75,
        "implementation": "Create configurable init file generator with template parameters"
      },
      "recommendation": "Use template method pattern with customizable sections",
      "priority": 2
    },

    {
      "id": "PATTERN-004",
      "title": "Neo4j Schema: 80% Duplicate Initialization Logic",
      "category": "code_duplication",
      "severity": "high",
      "impact": "maintenance_burden",
      "files_affected": [
        "src/amplihack/memory/neo4j/schema.py:35-58",
        "src/amplihack/memory/neo4j/neo4j_schema.py"
      ],
      "duplication_metrics": {
        "lines_duplicated": "~150 (estimated)",
        "similarity_percentage": 80,
        "maintenance_multiplier": 2
      },
      "description": "Schema initialization, constraint creation, and seed data logic duplicated across two schema managers",
      "code_smell": "Duplicated initialization patterns for constraints, indexes, and agent types",
      "consolidation_opportunity": {
        "pattern": "Single Responsibility",
        "suggested_action": "Consolidate to schema.py, deprecate neo4j_schema.py",
        "estimated_lines_saved": 150,
        "implementation": "Keep SchemaManager in schema.py, remove redundant neo4j_schema.py"
      },
      "recommendation": "Merge into single SchemaManager class in schema.py",
      "priority": 1
    },

    {
      "id": "PATTERN-005",
      "title": "Proxy Providers: HTTP Client Session Management Duplication (60% similarity)",
      "category": "code_duplication",
      "severity": "high",
      "impact": "maintenance_burden",
      "files_affected": [
        "src/amplihack/proxy/azure_unified_integration.py:83-123",
        "src/amplihack/proxy/github_client.py:33-50",
        "src/amplihack/proxy/responses_api_proxy.py"
      ],
      "duplication_metrics": {
        "lines_duplicated": 80,
        "similarity_percentage": 60,
        "maintenance_multiplier": 3
      },
      "description": "Three different implementations of HTTP client session initialization with headers, timeouts, SSL",
      "code_smell": "Feature Envy - each provider reimplements session management",
      "consolidation_opportunity": {
        "pattern": "Factory Pattern",
        "suggested_location": "src/amplihack/proxy/session_factory.py",
        "estimated_lines_saved": 150,
        "implementation": "class SessionFactory with create_session(provider_type, config) method"
      },
      "recommendation": "Create shared SessionFactory with provider-specific configurations",
      "priority": 2
    },

    {
      "id": "PATTERN-006",
      "title": "Subprocess Invocation: 2,678 Usages Without Standardized Pattern",
      "category": "primitive_obsession",
      "severity": "high",
      "impact": "error_handling_inconsistency",
      "files_affected": [
        "Multiple files (2,678 total subprocess calls)"
      ],
      "duplication_metrics": {
        "occurrences": 2678,
        "consistency_score": "low",
        "error_handling_variance": "high"
      },
      "description": "Raw subprocess.run() calls scattered throughout codebase without consistent error handling, timeout, or logging",
      "code_smell": "Primitive Obsession - using subprocess module directly instead of wrapped utility",
      "consolidation_opportunity": {
        "pattern": "Facade Pattern",
        "suggested_location": "src/amplihack/utils/subprocess_utils.py",
        "estimated_lines_saved": 500,
        "implementation": "class SubprocessRunner with run_command(cmd, timeout, capture, check) with standardized error handling"
      },
      "recommendation": "Create subprocess_utils.py with SubprocessRunner class for consistent invocations",
      "priority": 1
    },

    {
      "id": "PATTERN-007",
      "title": "Validation Functions: 48+ Scattered Validation Methods",
      "category": "missing_pattern",
      "severity": "medium",
      "impact": "code_organization",
      "files_affected": [
        "20 files with validate/check_valid methods"
      ],
      "duplication_metrics": {
        "validation_functions": 48,
        "common_patterns": [
          "path validation",
          "config validation",
          "schema validation"
        ]
      },
      "description": "Validation logic scattered across 20+ files without consistent approach or reusable patterns",
      "code_smell": "Missing Strategy Pattern for validation",
      "consolidation_opportunity": {
        "pattern": "Strategy Pattern + Validator Chain",
        "suggested_location": "src/amplihack/utils/validators.py",
        "estimated_lines_saved": 200,
        "implementation": "class Validator protocol with PathValidator, ConfigValidator, SchemaValidator implementations"
      },
      "recommendation": "Implement Validator protocol with common validation strategies",
      "priority": 3
    },

    {
      "id": "PATTERN-008",
      "title": "Custom Exception Classes: 20+ Files Without Shared Base",
      "category": "missing_pattern",
      "severity": "medium",
      "impact": "error_handling_consistency",
      "files_affected": [
        "20+ files defining custom exceptions"
      ],
      "duplication_metrics": {
        "exception_classes": 30,
        "shared_attributes": [
          "context",
          "error_code",
          "recoverable"
        ]
      },
      "description": "Custom exceptions defined independently without shared base class or common attributes",
      "consolidation_opportunity": {
        "pattern": "Exception Hierarchy",
        "suggested_location": "src/amplihack/exceptions.py",
        "estimated_lines_saved": 150,
        "implementation": "class AmplihackException(Exception) with context, code, recoverable attributes"
      },
      "recommendation": "Create base AmplihackException with common exception infrastructure",
      "priority": 3
    },

    {
      "id": "PATTERN-009",
      "title": "Neo4j Manager Classes: God Object Anti-Pattern",
      "category": "anti_pattern",
      "severity": "high",
      "impact": "maintainability",
      "files_affected": [
        "src/amplihack/memory/neo4j/lifecycle.py",
        "src/amplihack/memory/neo4j/agent_memory.py",
        "src/amplihack/neo4j/manager.py"
      ],
      "description": "Multiple manager classes handling container lifecycle, schema, queries, and business logic",
      "code_smell": "God Object - classes doing too many things",
      "anti_pattern_details": {
        "responsibilities_per_class": "6-8",
        "recommended_responsibilities": "1-2",
        "complexity_score": "high"
      },
      "consolidation_opportunity": {
        "pattern": "Single Responsibility Principle",
        "suggested_refactoring": "Split into ContainerManager, SchemaManager, QueryManager, MemoryStore",
        "estimated_impact": "Improved testability and maintainability"
      },
      "recommendation": "Already partially addressed with SchemaManager - continue splitting responsibilities",
      "priority": 2
    },

    {
      "id": "PATTERN-010",
      "title": "Bundle Generator: Missing Factory Pattern for Agent Generation",
      "category": "missing_pattern",
      "severity": "medium",
      "impact": "extensibility",
      "files_affected": [
        "src/amplihack/bundle_generator/generator.py"
      ],
      "description": "AgentGenerator class directly instantiates GeneratedAgent without factory abstraction",
      "missing_pattern_details": {
        "current_approach": "Direct instantiation",
        "limitation": "Hard to extend for new agent types",
        "extension_points": "Limited"
      },
      "consolidation_opportunity": {
        "pattern": "Factory Pattern",
        "suggested_location": "src/amplihack/bundle_generator/agent_factory.py",
        "estimated_lines_saved": 50,
        "implementation": "class AgentFactory with create_agent(type, requirements) supporting multiple agent types"
      },
      "recommendation": "Introduce AgentFactory for better extensibility",
      "priority": 4
    },

    {
      "id": "PATTERN-011",
      "title": "Proxy Manager: Feature Envy - Excessive Provider Access",
      "category": "anti_pattern",
      "severity": "medium",
      "impact": "coupling",
      "files_affected": [
        "src/amplihack/proxy/manager.py"
      ],
      "description": "ProxyManager accesses internal details of AzureProvider, GitHubProvider, ClaudeProvider",
      "code_smell": "Feature Envy - manager class reaches into provider internals",
      "anti_pattern_details": {
        "coupling_score": "high",
        "provider_internal_access": "frequent",
        "encapsulation_violations": "multiple"
      },
      "consolidation_opportunity": {
        "pattern": "Facade Pattern + Tell Don't Ask",
        "suggested_refactoring": "Providers expose higher-level operations, manager delegates instead of reaching in",
        "estimated_impact": "Reduced coupling, improved encapsulation"
      },
      "recommendation": "Refactor to use provider facades with high-level operations",
      "priority": 3
    },

    {
      "id": "PATTERN-012",
      "title": "Primitive Obsession: Dict Usage Instead of Dataclasses",
      "category": "anti_pattern",
      "severity": "medium",
      "impact": "type_safety",
      "files_affected": [
        "Multiple files using Dict[str, Any] for structured data"
      ],
      "description": "Heavy use of Dict[str, Any] for configuration, metadata, and structured data instead of dataclasses",
      "code_smell": "Primitive Obsession - dictionaries used where domain objects should exist",
      "anti_pattern_details": {
        "dict_usage_count": "high",
        "type_safety_score": "low",
        "refactoring_opportunity": "high"
      },
      "consolidation_opportunity": {
        "pattern": "Domain Models with Dataclasses",
        "suggested_refactoring": "Convert common dict patterns to @dataclass domain objects",
        "estimated_impact": "Improved type safety, better IDE support, clearer contracts",
        "examples": [
          "Configuration dicts → ConfigModel dataclass",
          "Metadata dicts → MetadataModel dataclass",
          "Request/Response dicts → RequestModel/ResponseModel dataclasses"
        ]
      },
      "recommendation": "Systematically replace Dict[str, Any] with typed dataclasses for domain concepts",
      "priority": 3
    }
  ],

  "consolidation_opportunities_summary": {
    "total_opportunities": 12,
    "estimated_total_lines_saved": 1550,
    "estimated_files_eliminated": 2,
    "priority_distribution": {
      "priority_1": 4,
      "priority_2": 3,
      "priority_3": 4,
      "priority_4": 1
    }
  },

  "impact_analysis": {
    "maintenance_burden_reduction": {
      "before": "458 issues + scattered duplication",
      "after": "~300 issues with consolidated patterns",
      "reduction_percentage": "35%"
    },
    "code_quality_improvements": [
      "Reduced shotgun surgery risk (setup.py changes)",
      "Improved consistency (subprocess, validation)",
      "Better type safety (dataclasses over dicts)",
      "Enhanced testability (smaller, focused classes)"
    ],
    "risk_assessment": {
      "refactoring_risk": "medium",
      "breaking_changes": "possible for internal APIs",
      "test_coverage_needed": "high",
      "migration_strategy": "incremental, module-by-module"
    }
  },

  "immediate_action_items": [
    {
      "priority": 1,
      "action": "Extract Bundle Generator Python packaging to shared utilities",
      "files": [
        "Create: src/amplihack/bundle_generator/python_packaging_utils.py",
        "Refactor: packager.py and filesystem_packager.py"
      ],
      "estimated_effort": "2-3 hours",
      "lines_saved": 255
    },
    {
      "priority": 1,
      "action": "Consolidate Neo4j schema initialization to single SchemaManager",
      "files": [
        "Keep: src/amplihack/memory/neo4j/schema.py",
        "Deprecate: src/amplihack/memory/neo4j/neo4j_schema.py"
      ],
      "estimated_effort": "1-2 hours",
      "lines_saved": 150
    },
    {
      "priority": 1,
      "action": "Create subprocess_utils.py with standardized SubprocessRunner",
      "files": [
        "Create: src/amplihack/utils/subprocess_utils.py"
      ],
      "estimated_effort": "4-6 hours (includes migration)",
      "lines_saved": 500,
      "note": "High impact but requires systematic migration of 2,678 call sites"
    },
    {
      "priority": 2,
      "action": "Create proxy SessionFactory for HTTP client management",
      "files": [
        "Create: src/amplihack/proxy/session_factory.py",
        "Refactor: azure_unified_integration.py, github_client.py, responses_api_proxy.py"
      ],
      "estimated_effort": "2-3 hours",
      "lines_saved": 150
    }
  ],

  "long_term_recommendations": [
    {
      "recommendation": "Implement comprehensive Validator protocol with strategy pattern",
      "effort": "3-4 hours",
      "benefit": "Consistent validation across codebase"
    },
    {
      "recommendation": "Create base AmplihackException with common exception infrastructure",
      "effort": "2-3 hours",
      "benefit": "Better error handling and debugging"
    },
    {
      "recommendation": "Continue splitting Neo4j God Objects into focused managers",
      "effort": "6-8 hours",
      "benefit": "Improved testability and maintainability"
    },
    {
      "recommendation": "Systematic replacement of Dict[str, Any] with domain dataclasses",
      "effort": "Ongoing, 10-15 hours total",
      "benefit": "Type safety, IDE support, clearer contracts"
    }
  ],

  "metrics": {
    "code_duplication": {
      "setup_py_generation": {
        "files": 2,
        "lines": 35,
        "similarity": "85%"
      },
      "pyproject_toml_generation": {
        "files": 1,
        "lines": 63,
        "similarity": "N/A"
      },
      "init_py_generation": {
        "files": 2,
        "lines": 45,
        "similarity": "70%"
      },
      "neo4j_schema": {
        "files": 2,
        "lines": 150,
        "similarity": "80%"
      },
      "http_session_management": {
        "files": 3,
        "lines": 80,
        "similarity": "60%"
      }
    },
    "anti_patterns": {
      "god_objects": 3,
      "feature_envy": 1,
      "primitive_obsession": "widespread"
    },
    "missing_patterns": {
      "factory_pattern": 1,
      "strategy_pattern": 1,
      "facade_pattern": 1
    },
    "subprocess_calls": 2678,
    "validation_functions": 48,
    "exception_classes": 30
  },

  "conclusion": {
    "summary": "Identified 12 significant pattern violations and code duplication opportunities beyond initial 458 issues",
    "total_potential_savings": "1,550+ lines of code",
    "files_potentially_eliminated": 2,
    "highest_impact_items": [
      "Bundle Generator Python packaging consolidation (255 lines saved)",
      "Neo4j schema consolidation (150 lines saved)",
      "Subprocess standardization (500 lines saved, 2678 call sites)",
      "Proxy HTTP session factory (150 lines saved)"
    ],
    "recommended_approach": "Incremental refactoring starting with Priority 1 items",
    "estimated_total_effort": "20-30 hours for all Priority 1 and 2 items"
  }
}
