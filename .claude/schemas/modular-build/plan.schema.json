{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://amplihack.dev/schemas/modular-build/plan.schema.json",
  "title": "Modular Build Plan Schema",
  "description": "Schema for implementation planning in the Plan phase",
  "type": "object",
  "required": [
    "implementation_roadmap",
    "dependencies_order",
    "validation_checkpoints",
    "plan_version"
  ],
  "properties": {
    "implementation_roadmap": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["step", "description", "estimated_time", "dependencies", "deliverables"],
        "properties": {
          "step": {
            "type": "integer",
            "minimum": 1,
            "description": "Step number in execution order"
          },
          "description": {
            "type": "string",
            "minLength": 10,
            "description": "Detailed description of the implementation step"
          },
          "estimated_time": {
            "type": "string",
            "pattern": "^[0-9]+[mh]$",
            "description": "Estimated time (e.g., '30m', '2h')"
          },
          "dependencies": {
            "type": "array",
            "items": { "type": "integer", "minimum": 1 },
            "description": "List of step numbers this step depends on"
          },
          "deliverables": {
            "type": "array",
            "items": { "type": "string" },
            "minItems": 1,
            "description": "Expected outputs from this step"
          },
          "assigned_agents": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "architect",
                "builder",
                "tester",
                "security",
                "database",
                "api-designer",
                "integration",
                "optimizer",
                "reviewer"
              ]
            },
            "description": "Agents responsible for this step"
          },
          "validation_criteria": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Criteria to validate step completion"
          }
        },
        "additionalProperties": false
      }
    },
    "dependencies_order": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Ordered list of dependencies to resolve/install"
    },
    "validation_checkpoints": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["checkpoint", "criteria", "validation_method"],
        "properties": {
          "checkpoint": {
            "type": "string",
            "description": "Name of the validation checkpoint"
          },
          "criteria": {
            "type": "array",
            "items": { "type": "string" },
            "minItems": 1,
            "description": "List of criteria that must be met"
          },
          "validation_method": {
            "type": "string",
            "enum": ["automated", "manual", "external_tool"],
            "description": "How this checkpoint will be validated"
          },
          "required_tools": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Tools required for validation (if external_tool)"
          },
          "failure_action": {
            "type": "string",
            "enum": ["abort", "retry", "continue_with_warning"],
            "description": "Action to take if validation fails"
          }
        },
        "additionalProperties": false
      }
    },
    "risk_assessment": {
      "type": "object",
      "properties": {
        "identified_risks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["risk", "probability", "impact", "mitigation"],
            "properties": {
              "risk": { "type": "string" },
              "probability": { "type": "string", "enum": ["low", "medium", "high"] },
              "impact": { "type": "string", "enum": ["low", "medium", "high"] },
              "mitigation": { "type": "string" }
            }
          }
        },
        "contingency_plans": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "resource_requirements": {
      "type": "object",
      "properties": {
        "development_time": { "type": "string" },
        "testing_time": { "type": "string" },
        "external_dependencies": { "type": "array", "items": { "type": "string" } },
        "required_permissions": { "type": "array", "items": { "type": "string" } }
      }
    },
    "plan_version": {
      "type": "string",
      "pattern": "^v[0-9]+\\.[0-9]+$",
      "description": "Plan version"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_at": { "type": "string", "format": "date-time" },
        "spec_reference": { "type": "string" },
        "total_estimated_time": { "type": "string" },
        "critical_path": { "type": "array", "items": { "type": "integer" } }
      }
    }
  },
  "additionalProperties": false
}
