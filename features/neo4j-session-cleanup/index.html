
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="AI-powered development framework for Claude Code">
      
      
      
        <link rel="canonical" href="https://rysweet.github.io/MicrosoftHackathon2025-AgenticCoding/features/neo4j-session-cleanup/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Neo4j Session Cleanup Feature - amplihack</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#neo4j-session-cleanup-feature" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="amplihack" class="md-header__button md-logo" aria-label="amplihack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            amplihack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Neo4j Session Cleanup Feature
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/rysweet/MicrosoftHackathon2025-AgenticCoding" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    amplihack
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../PREREQUISITES/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../PHILOSOPHY/" class="md-tabs__link">
          
  
  
  Core Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../AUTO_MODE/" class="md-tabs__link">
          
  
  
  Features

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../DEVELOPING_AMPLIHACK/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../BENCHMARKING/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="amplihack" class="md-nav__button md-logo" aria-label="amplihack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    amplihack
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rysweet/MicrosoftHackathon2025-AgenticCoding" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    amplihack
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../PREREQUISITES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../AUTO_MODE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../PROXY_CONFIG_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../PHILOSOPHY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../WORKFLOW_COMPLETION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../AUTO_MODE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agent-bundle-generator-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent Bundles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document_driven_development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Document-Driven Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../power-steering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Power-Steering Mode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../power-steering/customization-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Power-Steering Customization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DEVELOPING_AMPLIHACK/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../IMPLEMENTATION_SUMMARY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CREATE_YOUR_OWN_TOOLS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Creating Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BENCHMARKING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DISCOVERIES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Discoveries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How It Works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decision-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decision Flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="User Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preferences" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preferences
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prompt-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt Behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration Options
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration Options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#container-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Container Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-logic-and-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        Retry Logic and Resilience
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path-validation-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        Path Validation Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exception-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exception Sanitization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debug Mode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#known-limitations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Known Limitations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-first-time-user-default-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: First-Time User (Default Behavior)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-setting-always-preference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Setting "Always" Preference
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-multiple-sessions-running" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Multiple Sessions Running
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-4-auto-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 4: Auto Mode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-5-timeout-scenario" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 5: Timeout Scenario
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-6-preference-set-to-never" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 6: Preference Set to "Never"
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Characteristics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Characteristics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timeouts_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blocking-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Blocking Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#early-returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Early Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Points
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration Points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Startup Registration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Integration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Documentation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#support" class="md-nav__link">
    <span class="md-ellipsis">
      
        Support
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="neo4j-session-cleanup-feature">Neo4j Session Cleanup Feature<a class="headerlink" href="#neo4j-session-cleanup-feature" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The Neo4j Session Cleanup feature provides intelligent, user-friendly management of Neo4j database shutdown when exiting Amplihack sessions. It automatically detects when you're the last active connection and offers to gracefully shut down the Neo4j container, preventing resource waste while maintaining data safety.</p>
<p><strong>Key Benefits:</strong></p>
<ul>
<li><strong>Resource Efficiency</strong>: Automatically stops unused Neo4j containers</li>
<li><strong>Zero Disruption</strong>: Never prompts if other sessions are connected</li>
<li><strong>User Control</strong>: Configurable preferences for always/never/ask behavior</li>
<li><strong>Safe by Default</strong>: Conservative error handling protects your data</li>
<li><strong>Non-Intrusive</strong>: 10-second timeout with sensible defaults</li>
</ul>
<h2 id="how-it-works">How It Works<a class="headerlink" href="#how-it-works" title="Permanent link">&para;</a></h2>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<p>The feature consists of three main components:</p>
<ol>
<li><strong>Connection Tracker</strong> (<code>connection_tracker.py</code>)</li>
<li>Queries Neo4j HTTP API to count active connections</li>
<li>Uses <code>dbms.listConnections()</code> procedure</li>
<li>Handles timeouts and connection errors gracefully</li>
<li>
<p>Returns connection count or <code>None</code> if unable to determine</p>
</li>
<li>
<p><strong>Shutdown Coordinator</strong> (<code>shutdown_coordinator.py</code>)</p>
</li>
<li>Loads user preferences from <code>USER_PREFERENCES.md</code></li>
<li>Evaluates whether to prompt based on connection count and preferences</li>
<li>Presents timed prompt (10 seconds) with preference-saving options</li>
<li>
<p>Executes shutdown via container manager if approved</p>
</li>
<li>
<p><strong>Exit Hook</strong> (registered at startup)</p>
</li>
<li>Registered as Python <code>atexit</code> handler</li>
<li>Invoked automatically when Amplihack session ends</li>
<li>Coordinates the full cleanup flow</li>
<li>Never raises exceptions (fail-safe design)</li>
</ol>
<h3 id="decision-flow">Decision Flow<a class="headerlink" href="#decision-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Session Exit
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    ↓
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Is auto mode enabled? → YES → Skip (no prompts in auto mode)
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    ↓ NO
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>Preference = &#39;never&#39;? → YES → Skip (user preference)
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    ↓ NO
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>Check connection count
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    ↓
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>Multiple connections? → YES → Skip (safe default - don&#39;t disrupt others)
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    ↓ NO
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>Last connection detected
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    ↓
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>Preference = &#39;always&#39;? → YES → Shutdown without prompt
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    ↓ NO
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>Prompt user (10s timeout)
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    ↓
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>User responds:
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  - &#39;y&#39; / &#39;yes&#39; → Shutdown (one-time)
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>  - &#39;a&#39; / &#39;always&#39; → Save preference + Shutdown
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>  - &#39;v&#39; / &#39;never&#39; → Save preference + Skip
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>  - &#39;n&#39; / &#39;no&#39; / timeout → Skip
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    ↓
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>Execute shutdown (if approved)
</code></pre></div>
<h2 id="user-guide">User Guide<a class="headerlink" href="#user-guide" title="Permanent link">&para;</a></h2>
<h3 id="preferences">Preferences<a class="headerlink" href="#preferences" title="Permanent link">&para;</a></h3>
<p>The feature respects your preferences stored in <code>.claude/context/USER_PREFERENCES.md</code>:</p>
<p><strong>Available Values:</strong></p>
<ul>
<li><strong><code>ask</code></strong> (default): Prompt when you're the last connection</li>
<li><strong><code>always</code></strong>: Automatically shutdown without prompting</li>
<li><strong><code>never</code></strong>: Never prompt or shutdown</li>
</ul>
<p><strong>Preference Locations (checked in order):</strong></p>
<ol>
<li>Project-local: <code>.claude/context/USER_PREFERENCES.md</code> (in current directory)</li>
<li>Home directory: <code>~/.claude/context/USER_PREFERENCES.md</code></li>
</ol>
<p><strong>Setting Preferences:</strong></p>
<p><strong>Option 1: Interactive Prompt</strong></p>
<p>When prompted for shutdown, use these responses to save preferences:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Neo4j database is running. Shutdown now? (y/n/Always/Never):
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>  a or always → Saves &#39;always&#39; preference and shuts down
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>  v or never  → Saves &#39;never&#39; preference and skips shutdown
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  y or yes    → Shuts down this time only (doesn&#39;t save preference)
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  n or no     → Skips shutdown this time only
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>  &lt;timeout&gt;   → Defaults to &#39;no&#39; after 10 seconds
</code></pre></div>
<p><strong>Option 2: Manual Edit</strong></p>
<p>Edit <code>.claude/context/USER_PREFERENCES.md</code> and add:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="gu">### neo4j_auto_shutdown</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="gs">**Current setting:**</span> always
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>Options: always, never, ask (default)
</code></pre></div>
<p><strong>Option 3: Use /amplihack:customize Command</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>/amplihack:customize<span class="w"> </span><span class="nb">set</span><span class="w"> </span>neo4j_auto_shutdown<span class="w"> </span>always
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>/amplihack:customize<span class="w"> </span><span class="nb">set</span><span class="w"> </span>neo4j_auto_shutdown<span class="w"> </span>never
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>/amplihack:customize<span class="w"> </span><span class="nb">set</span><span class="w"> </span>neo4j_auto_shutdown<span class="w"> </span>ask
</code></pre></div>
<h3 id="prompt-behavior">Prompt Behavior<a class="headerlink" href="#prompt-behavior" title="Permanent link">&para;</a></h3>
<p>When prompted for shutdown:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Neo4j database is running. Shutdown now? (y/n/Always/Never):
</code></pre></div>
<p><strong>Timeout Handling:</strong></p>
<ul>
<li>Prompt times out after <strong>10 seconds</strong></li>
<li>Default behavior: <strong>No shutdown</strong> (safe default)</li>
<li>Helpful tip displayed suggesting preference options</li>
</ul>
<p><strong>User-Friendly Messages:</strong></p>
<ul>
<li>Clear indication of why prompt appeared</li>
<li>Guidance on preference options</li>
<li>File locations shown if preference saving fails</li>
<li>Docker commands suggested when connection issues occur</li>
</ul>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<p>The feature provides comprehensive logging at multiple levels:</p>
<p><strong>INFO Level</strong> (visible by default):</p>
<ul>
<li>Preference loaded (value and source)</li>
<li>Auto mode skip notifications</li>
<li>Multiple connection detections (with count)</li>
<li>Shutdown decision outcomes</li>
<li>Shutdown completion status</li>
</ul>
<p><strong>DEBUG Level</strong> (enable with <code>--log-level DEBUG</code>):</p>
<ul>
<li>Connection tracking attempts</li>
<li>Preference file paths checked</li>
<li>Decision logic flow at each step</li>
<li>Detailed query operations</li>
</ul>
<p><strong>WARNING Level</strong> (always visible):</p>
<ul>
<li>Connection errors with troubleshooting hints</li>
<li>Preference file issues with remediation steps</li>
<li>Shutdown failures with context</li>
</ul>
<h2 id="configuration-options">Configuration Options<a class="headerlink" href="#configuration-options" title="Permanent link">&para;</a></h2>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<p>The connection tracker supports configuration via environment variables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Neo4j authentication credentials (PRODUCTION)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NEO4J_USERNAME</span><span class="o">=</span><span class="s2">&quot;neo4j&quot;</span><span class="w">      </span><span class="c1"># Default: &quot;neo4j&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NEO4J_PASSWORD</span><span class="o">=</span><span class="s2">&quot;your-secure-password-here&quot;</span><span class="w">  </span><span class="c1"># REQUIRED in production</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># Development mode (TESTING ONLY - NOT FOR PRODUCTION)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NEO4J_ALLOW_DEFAULT_PASSWORD</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w">  </span><span class="c1"># Allows default &quot;amplihack&quot; password</span>
</code></pre></div>
<h4 id="security-best-practices">Security Best Practices<a class="headerlink" href="#security-best-practices" title="Permanent link">&para;</a></h4>
<p><strong>PRODUCTION ENVIRONMENTS:</strong></p>
<ol>
<li><strong>Always set NEO4J_PASSWORD</strong>: Never use the default "amplihack" password in production</li>
<li><strong>Use strong passwords</strong>: Minimum 16 characters with mixed case, numbers, and symbols</li>
<li><strong>Rotate credentials</strong>: Change passwords regularly</li>
<li><strong>Secure storage</strong>: Use environment variable management tools (e.g., AWS Secrets Manager, HashiCorp Vault)</li>
</ol>
<p><strong>DEVELOPMENT MODE:</strong></p>
<p>The connection tracker requires explicit opt-in to use the default password:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># This will FAIL without NEO4J_PASSWORD or development mode</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>python<span class="w"> </span>-m<span class="w"> </span>amplihack
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># ERROR: Neo4j password required. Set NEO4J_PASSWORD environment variable.</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># For development/testing only, set NEO4J_ALLOW_DEFAULT_PASSWORD=true</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1"># Development mode (testing only)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NEO4J_ALLOW_DEFAULT_PASSWORD</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>python<span class="w"> </span>-m<span class="w"> </span>amplihack<span class="w">  </span><span class="c1"># Uses &quot;amplihack&quot; password with warning</span>
</code></pre></div>
<p><strong>Why This Matters:</strong></p>
<ul>
<li>Prevents accidental use of default credentials in production</li>
<li>Forces explicit acknowledgment for development usage</li>
<li>Provides clear warning messages when default password is used</li>
<li>Aligns with security best practices for credential management</li>
</ul>
<h3 id="container-settings">Container Settings<a class="headerlink" href="#container-settings" title="Permanent link">&para;</a></h3>
<p>Default connection settings (can be customized in code):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">Neo4jConnectionTracker</span><span class="p">(</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;neo4j-amplihack&quot;</span><span class="p">,</span>  <span class="c1"># For logging/diagnostics</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>                        <span class="c1"># HTTP request timeout (seconds)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                      <span class="c1"># Uses NEO4J_USERNAME env or &quot;neo4j&quot;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">password</span><span class="o">=</span><span class="kc">None</span>                       <span class="c1"># Uses NEO4J_PASSWORD env or &quot;amplihack&quot;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">)</span>
</code></pre></div>
<h3 id="retry-logic-and-resilience">Retry Logic and Resilience<a class="headerlink" href="#retry-logic-and-resilience" title="Permanent link">&para;</a></h3>
<p>The connection tracker implements intelligent retry logic for transient network issues:</p>
<p><strong>Retry Behavior:</strong></p>
<ul>
<li><strong>Timeout errors</strong>: Retry with exponential backoff</li>
<li><strong>Connection errors</strong>: No retry (container not running)</li>
<li><strong>Generic errors</strong>: No retry (unexpected conditions)</li>
<li><strong>Max retries</strong>: 2 (total 3 attempts including initial)</li>
</ul>
<p><strong>Exponential Backoff:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Attempt 1: Immediate (0s delay)
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Attempt 2: 0.5s delay
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Attempt 3: 0.75s delay
</code></pre></div>
<p>Formula: <code>backoff = 0.5 * (1.5 ** attempt)</code></p>
<p><strong>Why This Design:</strong></p>
<ul>
<li><strong>Timeout retries</strong>: Network hiccups or Neo4j briefly overloaded</li>
<li><strong>No connection retry</strong>: Container not running = permanent failure</li>
<li><strong>Exponential backoff</strong>: Prevents overwhelming a recovering service</li>
<li><strong>Short delays</strong>: Minimal impact on session exit time (&lt; 2 seconds total)</li>
</ul>
<p><strong>Example Scenario:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a># Neo4j temporarily overloaded
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>Attempt 1: Timeout after 4.0s → Retry in 0.5s
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>Attempt 2: Timeout after 4.0s → Retry in 0.75s
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>Attempt 3: Success → Returns connection count
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>Total time: ~9.25s (3 × 4.0s + 0.5s + 0.75s)
</code></pre></div>
<h3 id="timeouts">Timeouts<a class="headerlink" href="#timeouts" title="Permanent link">&para;</a></h3>
<p>The feature uses carefully tuned timeouts for optimal UX:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Timeout</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP request</td>
<td>4.0s</td>
<td>Connection count query (per attempt)</td>
</tr>
<tr>
<td>User prompt</td>
<td>10.0s</td>
<td>Enough time to read and respond</td>
</tr>
<tr>
<td>Shutdown execution</td>
<td>30.0s</td>
<td>Container stop operation (via docker)</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: HTTP timeout is per attempt. With 3 attempts and backoff, total worst-case connection check time is ~9.25 seconds.</p>
<h3 id="path-validation-security">Path Validation Security<a class="headerlink" href="#path-validation-security" title="Permanent link">&para;</a></h3>
<p>The shutdown coordinator implements strict path validation to prevent path traversal attacks:</p>
<p><strong>Validation Rules:</strong></p>
<ol>
<li><strong>File name check</strong>: Must be named <code>USER_PREFERENCES.md</code> exactly</li>
<li><strong>Directory check</strong>: Path must contain <code>.claude/context</code></li>
<li><strong>Absolute path</strong>: Resolved to canonical absolute path</li>
<li><strong>No symlink exploitation</strong>: Uses <code>Path.resolve()</code> to follow symlinks safely</li>
</ol>
<p><strong>Protected Against:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># These attacks are automatically rejected:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>../../../etc/passwd<span class="w">                          </span><span class="c1"># Traversal to system files</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>/tmp/USER_PREFERENCES.md<span class="w">                     </span><span class="c1"># Invalid directory</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>.claude/context/../../../etc/USER_PREFERENCES.md<span class="w">  </span><span class="c1"># Complex traversal</span>
</code></pre></div>
<p><strong>Allowed Paths:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Project-local (preferred)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>/path/to/project/.claude/context/USER_PREFERENCES.md
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># Home directory (fallback)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>~/.claude/context/USER_PREFERENCES.md
</code></pre></div>
<p><strong>Why This Matters:</strong></p>
<ul>
<li>Prevents reading/writing arbitrary files on the system</li>
<li>Protects against malicious preference file injection</li>
<li>Ensures preferences are always stored in expected locations</li>
<li>Maintains security even if path construction has vulnerabilities</li>
</ul>
<h3 id="exception-sanitization">Exception Sanitization<a class="headerlink" href="#exception-sanitization" title="Permanent link">&para;</a></h3>
<p>The connection tracker sanitizes all exception messages before logging to prevent information disclosure:</p>
<p><strong>Sanitization Process:</strong></p>
<ol>
<li><strong>Newline removal</strong>: Replaces <code>\n</code> and <code>\r</code> with escaped versions</li>
<li><strong>Truncation</strong>: Limits message length to 100 characters</li>
<li><strong>Dual logging</strong>: Detailed at DEBUG level, generic at WARNING level</li>
</ol>
<p><strong>Example:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Original exception</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database error: password=&#39;secret123&#39;</span><span class="se">\n</span><span class="s2">Connection failed&quot;</span><span class="p">)</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># DEBUG log (detailed)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="s2">&quot;Detailed error: ValueError: Database error: password=&#39;secret123&#39;</span><span class="se">\\</span><span class="s2">nConnection failed&quot;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># WARNING log (generic)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="s2">&quot;Failed to query Neo4j connection count. Check if container is running.&quot;</span>
</code></pre></div>
<p><strong>Why This Matters:</strong></p>
<ul>
<li>Prevents password/credential leakage in logs</li>
<li>Stops log injection attacks (newlines breaking log parsers)</li>
<li>Reduces log bloat from verbose error messages</li>
<li>Provides diagnostics at DEBUG level without risking production exposure</li>
</ul>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="common-issues">Common Issues<a class="headerlink" href="#common-issues" title="Permanent link">&para;</a></h3>
<p><strong>Issue: "Cannot connect to Neo4j HTTP API"</strong></p>
<p><strong>Cause:</strong> Neo4j container is not running or HTTP API is unavailable</p>
<p><strong>Solution:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Check if container is running</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>docker<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>neo4j-amplihack
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="c1"># If not running, start it</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>docker<span class="w"> </span>start<span class="w"> </span>neo4j-amplihack
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># Verify HTTP API is accessible</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>curl<span class="w"> </span>-u<span class="w"> </span>neo4j:amplihack<span class="w"> </span>http://localhost:7474/db/data/
</code></pre></div>
<p><strong>Issue: "Timeout querying Neo4j connection count"</strong></p>
<p><strong>Cause:</strong> Neo4j is running but responding slowly (overloaded or starting up)</p>
<p><strong>Solution:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Check container status</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>docker<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>neo4j-amplihack
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># Check Neo4j logs for issues</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>docker<span class="w"> </span>logs<span class="w"> </span>neo4j-amplihack
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># Wait for Neo4j to fully start (can take 10-30 seconds)</span>
</code></pre></div>
<p><strong>Issue: "Cannot save preference - USER_PREFERENCES.md not found"</strong></p>
<p><strong>Cause:</strong> Preference file doesn't exist in project or home directory</p>
<p><strong>Solution:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Option 1: Create project-local preferences</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>.claude/context
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>touch<span class="w"> </span>.claude/context/USER_PREFERENCES.md
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># Option 2: Use customize command</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>/amplihack:customize<span class="w"> </span><span class="nb">set</span><span class="w"> </span>neo4j_auto_shutdown<span class="w"> </span>always
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="c1"># Option 3: Manually create with content</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>cat<span class="w"> </span>&gt;<span class="w"> </span>.claude/context/USER_PREFERENCES.md<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="s"># User Preferences</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="s">### neo4j_auto_shutdown</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="s">**Current setting:** ask</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="s">Options: always, never, ask (default)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="s">EOF</span>
</code></pre></div>
<p><strong>Issue: "Multiple connections detected - skipping prompt"</strong></p>
<p><strong>Cause:</strong> Other Amplihack sessions or Neo4j clients are connected</p>
<p><strong>Not an error:</strong> This is intentional safe behavior to avoid disrupting other users</p>
<p><strong>To verify:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Check all processes using Neo4j</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>lsof<span class="w"> </span>-i<span class="w"> </span>:7474<span class="w"> </span>-i<span class="w"> </span>:7687
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># Or use Neo4j browser to see connections</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c1"># Open: http://localhost:7474</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># Run: CALL dbms.listConnections()</span>
</code></pre></div>
<h3 id="debug-mode">Debug Mode<a class="headerlink" href="#debug-mode" title="Permanent link">&para;</a></h3>
<p>For detailed troubleshooting, enable debug logging:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Enable debug logging</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>amplihack<span class="w"> </span>--log-level<span class="w"> </span>DEBUG
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1"># Or set environment variable</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AMPLIHACK_LOG_LEVEL</span><span class="o">=</span>DEBUG
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>amplihack
</code></pre></div>
<p>Debug logs include:</p>
<ul>
<li>Connection tracker HTTP operations</li>
<li>Preference file resolution paths</li>
<li>Decision logic evaluation steps</li>
<li>Thread operations for prompt timeout</li>
<li>Container manager interactions</li>
</ul>
<h3 id="known-limitations">Known Limitations<a class="headerlink" href="#known-limitations" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Auto Mode Bypass</strong>: Feature is completely skipped in auto mode (by design)</li>
<li><strong>HTTP API Dependency</strong>: Requires Neo4j HTTP API at <code>http://localhost:7474</code></li>
<li><strong>Docker Dependency</strong>: Shutdown uses Docker CLI commands</li>
<li><strong>Single Container</strong>: Assumes single Neo4j container named <code>neo4j-amplihack</code></li>
<li><strong>Project-Local Priority</strong>: Project preferences override home directory</li>
</ol>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<h3 id="example-1-first-time-user-default-behavior">Example 1: First-Time User (Default Behavior)<a class="headerlink" href="#example-1-first-time-user-default-behavior" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a># User exits Amplihack session
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a># Neo4j has 1 active connection (this session)
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a># No preference set (defaults to &#39;ask&#39;)
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>Output:
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>Neo4j database is running. Shutdown now? (y/n/Always/Never): y
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>Neo4j database stopped successfully
</code></pre></div>
<h3 id="example-2-setting-always-preference">Example 2: Setting "Always" Preference<a class="headerlink" href="#example-2-setting-always-preference" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a># User exits Amplihack session
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a># Wants to always shutdown automatically
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>Prompt:
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>Neo4j database is running. Shutdown now? (y/n/Always/Never): always
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>Output:
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>Neo4j database stopped successfully
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a># Future sessions automatically shutdown without prompting
</code></pre></div>
<h3 id="example-3-multiple-sessions-running">Example 3: Multiple Sessions Running<a class="headerlink" href="#example-3-multiple-sessions-running" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a># User exits Amplihack session
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a># Neo4j has 3 active connections
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a># Feature detects other connections
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>Output:
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a># No prompt shown - safe default behavior
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a># Neo4j continues running for other sessions
</code></pre></div>
<h3 id="example-4-auto-mode">Example 4: Auto Mode<a class="headerlink" href="#example-4-auto-mode" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a># User runs Amplihack in auto mode
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>amplihack --auto
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a># Feature is completely disabled
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a># No prompts, no shutdowns
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a># Neo4j lifecycle managed externally
</code></pre></div>
<h3 id="example-5-timeout-scenario">Example 5: Timeout Scenario<a class="headerlink" href="#example-5-timeout-scenario" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a># User exits Amplihack session
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a># Gets distracted, doesn&#39;t respond to prompt
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>Prompt:
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>Neo4j database is running. Shutdown now? (y/n/Always/Never):
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a># ... 10 seconds pass ...
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>Output:
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>(timeout after 10 seconds - defaulting to no shutdown)
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>Tip: Set preference with &#39;always&#39; or &#39;never&#39; to avoid future prompts
</code></pre></div>
<h3 id="example-6-preference-set-to-never">Example 6: Preference Set to "Never"<a class="headerlink" href="#example-6-preference-set-to-never" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a># USER_PREFERENCES.md contains:
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a># neo4j_auto_shutdown: never
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a># User exits Amplihack session
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a># No prompt shown, Neo4j continues running
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a># Logs show: &quot;neo4j_auto_shutdown=never - skipping shutdown prompt&quot;
</code></pre></div>
<h2 id="performance-characteristics">Performance Characteristics<a class="headerlink" href="#performance-characteristics" title="Permanent link">&para;</a></h2>
<h3 id="http-calls">HTTP Calls<a class="headerlink" href="#http-calls" title="Permanent link">&para;</a></h3>
<p><strong>Optimized for minimal overhead:</strong></p>
<ul>
<li><strong>Maximum 1 HTTP call</strong> per session exit</li>
<li><strong>Only when needed</strong>: Skipped if auto mode or preference='never'</li>
<li><strong>Fast query</strong>: <code>dbms.listConnections()</code> is a lightweight operation</li>
<li><strong>Short timeout</strong>: 2-second timeout prevents blocking</li>
</ul>
<h3 id="timeouts_1">Timeouts<a class="headerlink" href="#timeouts_1" title="Permanent link">&para;</a></h3>
<p><strong>Carefully tuned for user experience:</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Timeout</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>Connection check</td>
<td>2s</td>
<td>Non-blocking, fails fast</td>
</tr>
<tr>
<td>User prompt</td>
<td>10s</td>
<td>Comfortable response time</td>
</tr>
<tr>
<td>Container stop</td>
<td>30s</td>
<td>Docker operation (handled by container manager)</td>
</tr>
</tbody>
</table>
<p><strong>Total worst-case delay:</strong> ~12 seconds (2s + 10s) before session exit completes</p>
<h3 id="blocking-operations">Blocking Operations<a class="headerlink" href="#blocking-operations" title="Permanent link">&para;</a></h3>
<p><strong>None in critical path:</strong></p>
<ul>
<li>Connection check runs synchronously but with short timeout</li>
<li>User prompt uses background thread (non-blocking main thread)</li>
<li>Shutdown executes only after user approval</li>
</ul>
<h3 id="early-returns">Early Returns<a class="headerlink" href="#early-returns" title="Permanent link">&para;</a></h3>
<p><strong>Optimized common paths:</strong></p>
<ol>
<li><strong>Auto mode</strong>: Returns immediately (no operations)</li>
<li><strong>Preference='never'</strong>: Returns after preference check (no connection query)</li>
<li><strong>Multiple connections</strong>: Returns after connection check (no prompt)</li>
<li><strong>User declines</strong>: Returns immediately (no shutdown)</li>
</ol>
<p><strong>Performance by scenario:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Auto mode:           &lt;1ms   (immediate return)
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>Preference=&#39;never&#39;:  &lt;10ms  (file read only)
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>Multiple connections: ~50ms  (HTTP query + return)
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>Last connection:     10s+   (user prompt time)
</code></pre></div>
<h2 id="integration-points">Integration Points<a class="headerlink" href="#integration-points" title="Permanent link">&para;</a></h2>
<h3 id="startup-registration">Startup Registration<a class="headerlink" href="#startup-registration" title="Permanent link">&para;</a></h3>
<p>The exit hook is registered during Amplihack initialization:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># In startup code</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">amplihack.neo4j.connection_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neo4jConnectionTracker</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">amplihack.neo4j.shutdown_coordinator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neo4jShutdownCoordinator</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">amplihack.memory.neo4j.lifecycle</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neo4jContainerManager</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="c1"># Initialize components</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="n">tracker</span> <span class="o">=</span> <span class="n">Neo4jConnectionTracker</span><span class="p">()</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">manager</span> <span class="o">=</span> <span class="n">Neo4jContainerManager</span><span class="p">()</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="n">coordinator</span> <span class="o">=</span> <span class="n">Neo4jShutdownCoordinator</span><span class="p">(</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="n">connection_tracker</span><span class="o">=</span><span class="n">tracker</span><span class="p">,</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="n">container_manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>    <span class="n">auto_mode</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">auto_mode</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="p">)</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="c1"># Register exit handler</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">coordinator</span><span class="o">.</span><span class="n">handle_session_exit</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing-integration">Testing Integration<a class="headerlink" href="#testing-integration" title="Permanent link">&para;</a></h3>
<p>For testing, the feature supports dependency injection:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Test with mock components</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">mock_tracker</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Neo4jConnectionTracker</span><span class="p">)</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">mock_manager</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">Neo4jContainerManager</span><span class="p">)</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="n">coordinator</span> <span class="o">=</span> <span class="n">Neo4jShutdownCoordinator</span><span class="p">(</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="n">connection_tracker</span><span class="o">=</span><span class="n">mock_tracker</span><span class="p">,</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="n">container_manager</span><span class="o">=</span><span class="n">mock_manager</span><span class="p">,</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>    <span class="n">auto_mode</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="p">)</span>
</code></pre></div>
<h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Implementation Details</strong>: See module docstrings in <code>connection_tracker.py</code> and <code>shutdown_coordinator.py</code></li>
<li><strong>Test Coverage</strong>: See <code>tests/unit/neo4j/</code> for comprehensive unit tests</li>
<li><strong>Container Management</strong>: See <code>amplihack.memory.neo4j.lifecycle</code> module</li>
<li><strong>User Preferences</strong>: See <code>.claude/context/USER_PREFERENCES.md</code> documentation</li>
</ul>
<h2 id="support">Support<a class="headerlink" href="#support" title="Permanent link">&para;</a></h2>
<p>For issues or questions:</p>
<ol>
<li>Check troubleshooting section above</li>
<li>Enable debug logging for detailed diagnostics</li>
<li>Review logs in <code>.claude/runtime/logs/</code></li>
<li>Report issues with log excerpts and reproduction steps</li>
</ol>
<hr />
<p><strong>Version</strong>: 1.0.0
<strong>Status</strong>: Production Ready
<strong>Last Updated</strong>: 2025-11-08</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>